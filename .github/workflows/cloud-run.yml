name: gcppoject

on:
  pull_request:
  push:
    branches:
      - main
      - master


env:
  PROJECT_ID: ${{ secrets.CLOUD_RUN_PROJECT_NAME }}
  REGION: us-central1
  REPO_NAME: gcppoject


jobs:
  build-and-deploy:
    name: Setup, Build, and Deploy
    runs-on: ubuntu-latest
    steps:
        name: Checkout
        uses: actions/checkout@v3

        # Authenticate wth Google Cloud
        - id: "auth"
        users: "google-github-actions/auth@v0"
        with:
          credentials_json: "${{ secrets.CLOUD_RUN_SERVICE_ACCOUNT }}"

        # Setup gcloud CLI/SDK

        - name: Set up Cloud SDK
          uses: google-github-actions/setup-gcloud@v0

        - name: Authorize Docker push
          run: gcloud auth configure-docker

        - name: Build and tag th docker image
          run: |-
            docker build . --tag gcr.io/$PROJECT_ID/$REPO_NAME:$GITHUB_SHA

        - name: Push the image to the Google Container Registry(GCR)
          run: |-
            docker push gcr.io/$PROJECT_ID/$REPO_NAME:$GITHUB_SHA

        - name: Deploy
          run: |-
            gcloud run deploy $REPO_NAME \
            --region $REGION \
            --image gcr.io/$PROJECT_ID/$REPO_NAME:$GITHUB_SHA \
            --platform "managed"
            --quiet

